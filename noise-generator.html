<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Worklet Noise Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom range slider styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #60a5fa;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #4b5563;
            border-radius: 2px;
        }
        input[type=range]:focus {
            outline: none;
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4 font-sans">

    <div class="max-w-3xl w-full bg-gray-800 rounded-xl shadow-2xl overflow-hidden border border-gray-700">
        <!-- Header -->
        <div class="p-6 border-b border-gray-700 bg-gray-800">
            <h1 class="text-xl font-bold text-blue-400 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
                Noise Generator
            </h1>
            <p class="text-xs text-gray-400 mt-1">AudioWorkletNode &bull; Advanced Context Configuration</p>
        </div>

        <!-- Visualizer Canvas -->
        <div class="relative h-48 bg-black w-full">
            <canvas id="visualizer" class="w-full h-full"></canvas>
            <div id="statusOverlay" class="absolute inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300">
                <span class="text-sm font-mono text-gray-300">Ready to Start</span>
            </div>
        </div>

        <!-- Controls -->
        <div class="p-6 space-y-6">
            
            <!-- Power Button -->
            <button id="toggleBtn" class="w-full group relative flex items-center justify-center gap-3 py-4 px-6 rounded-lg font-bold text-lg transition-all duration-200 bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/50 active:scale-95">
                <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <svg id="stopIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                </svg>
                <span id="btnText">Initialize Audio</span>
            </button>

            <!-- Settings Group -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <!-- Volume Control -->
                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-gray-400 font-medium uppercase tracking-wider">
                        <label for="volume">Volume</label>
                        <span id="volValue">20%</span>
                    </div>
                    <input type="range" id="volume" min="0" max="1" step="0.01" value="0.2" disabled>
                </div>

                <!-- Latency Configuration -->
                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-gray-400 font-medium uppercase tracking-wider">
                        <label for="latencySelect">Latency Hint</label>
                    </div>
                    <div class="flex gap-2">
                        <select id="latencySelect" class="bg-gray-700 text-sm text-white rounded px-2 py-1 w-full border border-gray-600 focus:outline-none focus:border-blue-400 transition-colors">
                            <option value="playback" selected>Playback</option>
                            <option value="balanced">Balanced</option>
                            <option value="interactive">Interactive</option>
                            <option value="custom">Custom (sec)</option>
                        </select>
                        <input type="number" id="latencyCustom" step="0.01" min="0" placeholder="0.1" class="hidden bg-gray-700 text-sm text-white rounded px-2 py-1 w-20 border border-gray-600 focus:outline-none focus:border-blue-400 text-center">
                    </div>
                </div>

                <!-- Render Size Configuration -->
                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-gray-400 font-medium uppercase tracking-wider">
                        <label for="renderSizeSelect">Render Size Hint</label>
                    </div>
                    <div class="flex gap-2">
                        <select id="renderSizeSelect" class="bg-gray-700 text-sm text-white rounded px-2 py-1 w-full border border-gray-600 focus:outline-none focus:border-blue-400 transition-colors">
                            <option value="default" selected>Default</option>
                            <option value="custom">Custom (frames)</option>
                        </select>
                        <input type="number" id="renderSizeCustom" step="1" min="0" placeholder="128" class="hidden bg-gray-700 text-sm text-white rounded px-2 py-1 w-20 border border-gray-600 focus:outline-none focus:border-blue-400 text-center">
                    </div>
                </div>

                <!-- Sample Rate Configuration -->
                <div class="space-y-2">
                    <div class="flex justify-between text-xs text-gray-400 font-medium uppercase tracking-wider">
                        <label for="sampleRateSelect">Sample Rate</label>
                    </div>
                    <div class="flex gap-2">
                        <select id="sampleRateSelect" class="bg-gray-700 text-sm text-white rounded px-2 py-1 w-full border border-gray-600 focus:outline-none focus:border-blue-400 transition-colors">
                            <option value="44100" selected>44.1 kHz</option>
                            <option value="48000">48 kHz</option>
                            <option value="88200">88.2 kHz</option>
                            <option value="96000">96 kHz</option>
                            <option value="custom">Custom (Hz)</option>
                        </select>
                        <input type="number" id="sampleRateCustom" step="100" min="8000" placeholder="44100" class="hidden bg-gray-700 text-sm text-white rounded px-2 py-1 w-20 border border-gray-600 focus:outline-none focus:border-blue-400 text-center">
                    </div>
                </div>
            </div>

            <!-- Stats/Info -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-2">
                <div class="bg-gray-700/50 p-3 rounded border border-gray-600">
                    <div class="text-[10px] uppercase tracking-wider text-gray-400">Context State</div>
                    <div id="ctxState" class="text-sm font-mono text-green-400">Closed</div>
                </div>
                <div class="bg-gray-700/50 p-3 rounded border border-gray-600">
                    <div class="text-[10px] uppercase tracking-wider text-gray-400">Active Latency</div>
                    <div id="activeHint" class="text-sm font-mono text-gray-500">-</div>
                </div>
                <div class="bg-gray-700/50 p-3 rounded border border-gray-600">
                    <div class="text-[10px] uppercase tracking-wider text-gray-400">Render Size</div>
                    <div id="activeRenderSize" class="text-sm font-mono text-gray-500">-</div>
                </div>
                <div class="bg-gray-700/50 p-3 rounded border border-gray-600">
                    <div class="text-[10px] uppercase tracking-wider text-gray-400">Sample Rate</div>
                    <div id="activeSampleRate" class="text-sm font-mono text-gray-500">-</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // 1. Define the AudioWorklet Processor as a String
        // ---------------------------------------------------------
        const workletCode = `
            class NoiseProcessor extends AudioWorkletProcessor {
                constructor() {
                    super();
                }

                process(inputs, outputs, parameters) {
                    const output = outputs[0];
                    output.forEach(channel => {
                        for (let i = 0; i < channel.length; i++) {
                            channel[i] = (Math.random() * 2) - 1;
                        }
                    });
                    return true;
                }
            }
            registerProcessor('noise-processor', NoiseProcessor);
        `;

        // ---------------------------------------------------------
        // 2. Application State & Elements
        // ---------------------------------------------------------
        let audioContext = null;
        let noiseNode = null;
        let gainNode = null;
        let analyser = null;
        let animationId = null;

        const toggleBtn = document.getElementById('toggleBtn');
        const playIcon = document.getElementById('playIcon');
        const stopIcon = document.getElementById('stopIcon');
        const btnText = document.getElementById('btnText');
        
        const volumeSlider = document.getElementById('volume');
        const volValue = document.getElementById('volValue');
        
        // Latency Controls
        const latencySelect = document.getElementById('latencySelect');
        const latencyCustom = document.getElementById('latencyCustom');
        const activeHintDisplay = document.getElementById('activeHint');

        // Render Size Controls
        const renderSizeSelect = document.getElementById('renderSizeSelect');
        const renderSizeCustom = document.getElementById('renderSizeCustom');
        const activeRenderSizeDisplay = document.getElementById('activeRenderSize');

        // Sample Rate Controls
        const sampleRateSelect = document.getElementById('sampleRateSelect');
        const sampleRateCustom = document.getElementById('sampleRateCustom');
        const activeSampleRateDisplay = document.getElementById('activeSampleRate');
        
        const ctxStateDisplay = document.getElementById('ctxState');
        const statusOverlay = document.getElementById('statusOverlay');
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');

        // Resize Canvas
        function resizeCanvas() {
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = canvas.parentElement.offsetHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ---------------------------------------------------------
        // 3. Helper Logic (Config Switching)
        // ---------------------------------------------------------
        
        async function restartAudio() {
            if (audioContext) {
                // Update UI to show we are rebooting
                ctxStateDisplay.innerText = "Recreating...";
                ctxStateDisplay.className = "text-sm font-mono text-blue-400";
                
                // Cleanup
                try {
                    await audioContext.close();
                } catch(e) { console.warn("Error closing context", e); }
                audioContext = null;
            }
            
            // Re-init
            await initAudio();
        }

        // --- Latency Listeners ---
        latencySelect.addEventListener('change', async (e) => {
            const isCustom = e.target.value === 'custom';
            if (isCustom) {
                latencyCustom.classList.remove('hidden');
                latencyCustom.focus();
            } else {
                latencyCustom.classList.add('hidden');
                if (audioContext) await restartAudio();
            }
        });

        latencyCustom.addEventListener('change', async () => {
            if (audioContext && latencySelect.value === 'custom') {
                await restartAudio();
            }
        });

        // --- Render Size Listeners ---
        renderSizeSelect.addEventListener('change', async (e) => {
            const isCustom = e.target.value === 'custom';
            if (isCustom) {
                renderSizeCustom.classList.remove('hidden');
                renderSizeCustom.focus();
            } else {
                renderSizeCustom.classList.add('hidden');
                if (audioContext) await restartAudio();
            }
        });

        renderSizeCustom.addEventListener('change', async () => {
            if (audioContext && renderSizeSelect.value === 'custom') {
                await restartAudio();
            }
        });

        // --- Sample Rate Listeners ---
        sampleRateSelect.addEventListener('change', async (e) => {
            const isCustom = e.target.value === 'custom';
            if (isCustom) {
                sampleRateCustom.classList.remove('hidden');
                sampleRateCustom.focus();
            } else {
                sampleRateCustom.classList.add('hidden');
                if (audioContext) await restartAudio();
            }
        });

        sampleRateCustom.addEventListener('change', async () => {
            if (audioContext && sampleRateSelect.value === 'custom') {
                await restartAudio();
            }
        });


        // ---------------------------------------------------------
        // 4. Audio Initialization Logic
        // ---------------------------------------------------------
        async function initAudio() {
            try {
                // Determine Latency Hint
                let latHint = latencySelect.value;
                if (latHint === 'custom') {
                    const val = parseFloat(latencyCustom.value);
                    latHint = isNaN(val) ? 0 : val;
                }

                // Determine Render Size Hint
                let rendHint = renderSizeSelect.value;
                if (rendHint === 'custom') {
                    const val = parseInt(renderSizeCustom.value, 10);
                    rendHint = isNaN(val) ? 'default' : val;
                }

                // Determine Sample Rate
                let sRate = sampleRateSelect.value;
                if (sRate === 'custom') {
                    const val = parseInt(sampleRateCustom.value, 10);
                    sRate = isNaN(val) ? 44100 : val;
                } else {
                    sRate = parseInt(sRate, 10);
                }

                // Create Blob for Worklet
                const blob = new Blob([workletCode], { type: 'application/javascript' });
                const workletUrl = URL.createObjectURL(blob);

                // Create Context with all options
                const ctxOptions = { 
                    latencyHint: latHint,
                    sampleRate: sRate
                };
                
                // Only add renderSizeHint if it is not default (or just pass 'default')
                if (rendHint !== undefined) {
                    ctxOptions.renderSizeHint = rendHint;
                }

                audioContext = new AudioContext(ctxOptions);

                // Update Display: Latency
                activeHintDisplay.innerText = (typeof latHint === 'number') ? `${latHint}s` : latHint;
                activeHintDisplay.classList.add('text-purple-400');
                activeHintDisplay.classList.remove('text-gray-500');

                // Update Display: Render Size
                let actualRenderSize = "unknown";
                if (typeof audioContext.renderQuantumSize !== 'undefined') {
                    actualRenderSize = audioContext.renderQuantumSize;
                }
                activeRenderSizeDisplay.innerText = (typeof actualRenderSize === 'number') ? `${actualRenderSize} f` : actualRenderSize;
                activeRenderSizeDisplay.classList.add('text-purple-400');
                activeRenderSizeDisplay.classList.remove('text-gray-500');

                // Update Display: Sample Rate (Read actual rate from context)
                const actualSR = audioContext.sampleRate;
                activeSampleRateDisplay.innerText = `${actualSR} Hz`;
                activeSampleRateDisplay.classList.add('text-purple-400');
                activeSampleRateDisplay.classList.remove('text-gray-500');

                // Add Module
                await audioContext.audioWorklet.addModule(workletUrl);

                // Create Nodes
                noiseNode = new AudioWorkletNode(audioContext, 'noise-processor');
                gainNode = audioContext.createGain();
                gainNode.gain.value = parseFloat(volumeSlider.value);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;

                // Connect Graph
                noiseNode.connect(gainNode);
                gainNode.connect(analyser);
                analyser.connect(audioContext.destination);

                // Update UI
                updateUIState(true);
                drawVisualizer();

            } catch (error) {
                console.error("Audio Init Failed:", error);
                btnText.innerText = "Error (See Console)";
                toggleBtn.classList.replace('bg-blue-600', 'bg-red-600');
            }
        }

        // ---------------------------------------------------------
        // 5. Interaction Logic
        // ---------------------------------------------------------
        toggleBtn.addEventListener('click', async () => {
            if (!audioContext) {
                btnText.innerText = "Loading Worklet...";
                await initAudio();
            } else {
                if (audioContext.state === 'running') {
                    await audioContext.suspend();
                    updateUIState(false);
                } else if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                    updateUIState(true);
                }
            }
        });

        volumeSlider.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            volValue.innerText = Math.round(val * 100) + '%';
            if (gainNode) {
                gainNode.gain.setTargetAtTime(val, audioContext.currentTime, 0.01);
            }
        });

        // ---------------------------------------------------------
        // 6. UI & Visualization
        // ---------------------------------------------------------
        function updateUIState(running) {
            if (running) {
                playIcon.classList.add('hidden');
                stopIcon.classList.remove('hidden');
                btnText.innerText = "Stop Noise";
                toggleBtn.classList.replace('bg-blue-600', 'bg-red-500');
                toggleBtn.classList.replace('hover:bg-blue-500', 'hover:bg-red-400');
                volumeSlider.disabled = false;
                ctxStateDisplay.innerText = "Running";
                ctxStateDisplay.className = "text-sm font-mono text-green-400";
                statusOverlay.style.opacity = '0';
            } else {
                playIcon.classList.remove('hidden');
                stopIcon.classList.add('hidden');
                btnText.innerText = "Resume Noise";
                toggleBtn.classList.replace('bg-red-500', 'bg-blue-600');
                toggleBtn.classList.replace('hover:bg-red-400', 'hover:bg-blue-500');
                ctxStateDisplay.innerText = "Suspended";
                ctxStateDisplay.className = "text-sm font-mono text-yellow-400";
                statusOverlay.style.opacity = '1';
                statusOverlay.querySelector('span').innerText = "Paused";
            }
        }

        function drawVisualizer() {
            if (animationId) cancelAnimationFrame(animationId);
            if (!analyser) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function render() {
                animationId = requestAnimationFrame(render);
                
                analyser.getByteTimeDomainData(dataArray);

                canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

                canvasCtx.lineWidth = 2;
                canvasCtx.strokeStyle = '#60a5fa';
                canvasCtx.beginPath();

                const sliceWidth = canvas.width * 1.0 / bufferLength;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const v = dataArray[i] / 128.0;
                    const y = v * canvas.height / 2;
                    if (i === 0) canvasCtx.moveTo(x, y);
                    else canvasCtx.lineTo(x, y);
                    x += sliceWidth;
                }

                canvasCtx.lineTo(canvas.width, canvas.height / 2);
                canvasCtx.stroke();
            }
            render();
        }

    </script>
</body>
</html>